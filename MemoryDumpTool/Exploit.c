// Exploit.c: Device specific exploit code
#include "Include/Application.h"
#include <Guid/FileInfo.h>

void DisplayCommonBanner()
{
  Print(L"\nYahallo - Tegra 3/4 Secure Boot Unlock Utility\n");
  Print(L"Be aware that this process can take a few minutes\n");
}

void SurfaceRTExploit()
{
  EFI_STATUS Status = EFI_SUCCESS;


  DisplayCommonBanner();
  Print(L"\nElevator for Surface RT\n");

  // Perform the TrustZone exploit, so TrustZone memory
  // can be unprotected from normal world
  Print(L"Hmmm.\n");
  PerformNvTegra3Exploit();
  Print(L"Hmmmmmm.\n");

  ArmDisableCachesAndMmu();
 
  UINT32 Something = *((UINT32 *)(EFI_PHYSICAL_ADDRESS)0x80000000);
  
  ArmEnableMmu();
  ArmEnableDataCache();
  ArmEnableInstructionCache();
  Print(L"Something at 0x80000000 with exploit: 0x%x\n", Something);
  if (Something == 0xFFFFFFFF) {
    Print(L"Something happened and the exploit doesn't work\n");
    Status = EFI_ABORTED;
    goto exit;
  }

  return;
 
exit:
  FinalizeApp();
}
